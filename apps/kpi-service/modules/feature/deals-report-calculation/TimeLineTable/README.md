# TimeLineTable Module

Изолированный модуль для отображения таймлайна сделок с возможностью фильтрации и различных режимов отображения. Модуль не зависит от основного deals-report модуля и может быть использован независимо.

## Архитектура

```
TimeLineTable/
├── model/
│   ├── types/           # TypeScript типы и интерфейсы
│   └── slice/           # Redux slice для состояния таймлайна
├── lib/
│   └── utils/           # Утилиты для расчетов
├── components/          # Переиспользуемые компоненты
├── features/           # Основные фичи
└── index.ts           # Экспорты модуля
```

## Основные компоненты

### DealsReportTimelineCompact
Главный компонент таймлайна, объединяющий все фильтры и таблицу.

### TimelineTable
Основная таблица с данными, поддерживающая три режима отображения:
- **detailed** - детальная матрица по месяцам и годам
- **average** - средние показатели по месяцам
- **total** - итоговые показатели по месяцам

### PeriodFilterComponent
Компонент фильтрации по периоду, статусу клиентов и индексации.

### TimelineModeSelector
Переключатель режимов отображения таймлайна.

### CompanyStatsComponent
Отображение статистики по компании (текущий, средний, итоговый показатели, индексация).

### TimelineCell
Ячейка таймлайна с поддержкой различных режимов отображения.

## Redux состояние

### TimelineState
```typescript
interface TimelineState {
    periodFilter: PeriodFilter;
    timelineMode: TimelineMode;
    expandedCompanies: Set<number>;
}
```

### Actions
- `setPeriodFilter` - установка фильтра периода
- `setTimelineMode` - смена режима отображения
- `toggleCompany` - переключение развернутости компании
- `setExpandedCompanies` - установка списка развернутых компаний
- `resetTimeline` - сброс состояния таймлайна

## Утилиты

### timeline.utils.ts
- `calculateCompanyStats` - расчет статистики компании
- `calculateYearlyMatrix` - расчет матрицы по годам
- `calculateMonthlyPayments` - расчет ежемесячных платежей
- `getDealColor` - получение цвета для сделки
- `getMinDateFromDeals` - получение минимальной даты из сделок

### analytics.utils.ts
- `calculateImplementationIndex` - расчет индекса реализации
- `calculateMonthlyIndexData` - расчет месячных данных индексации
- `calculateHeatmapData` - расчет данных для тепловой карты
- `getHeatmapColor` - получение цвета для тепловой карты

## Использование

### Базовое использование
```tsx
import { DealsReportTimelineCompact } from './TimeLineTable';

<DealsReportTimelineCompact companies={companies} />
```

### Независимость от Redux
Модуль использует локальное состояние React и не требует подключения к Redux store. Это делает его полностью изолированным и легко переносимым.

### Опциональная интеграция с Redux
Если нужно использовать Redux для управления состоянием, можно подключить timelineReducer к store:

```tsx
import { timelineReducer } from './TimeLineTable';

// В store configuration
const store = configureStore({
  reducer: {
    timeline: timelineReducer,
    // другие редьюсеры
  },
});
```

## Фильтрация

### По периоду
- Выбор начального и конечного года
- Автоматическая корректировка диапазона

### По статусу клиентов
- Все клиенты
- Только активные
- Только неактивные

### По индексации
- Все клиенты
- Растущие (рост > 0%)
- Падающие (падение < 0%)
- Стабильные (изменение в пределах ±5%)

## Режимы отображения

### Детализация
Показывает матрицу по месяцам и годам, где каждая ячейка содержит данные по конкретному месяцу конкретного года.

### Средние показатели
Показывает средние значения по месяцам за весь период.

### Итоговые показатели
Показывает общие суммы по месяцам за весь период.

## Обработка пересекающихся сделок

Модуль корректно обрабатывает случаи, когда у клиента есть несколько сделок, действующих одновременно. В таких случаях:
- Ежемесячные платежи суммируются
- Статистика рассчитывается с учетом всех активных сделок
- Цветовая индикация отражает общую динамику
